use super::{title_block, Context};
use crate::plugin::io::{Input, Terminal};
use bevy::{diagnostic::DiagnosticsStore, prelude::*};
use ratatui::{
    layout::{Constraint, Layout},
    text::Text,
    Frame,
};

const SPLASH: &str = r#"
░▒▓███████▓▒░░▒▓███████▓▒░ ░▒▓██████▓▒░ ░▒▓███████▓▒░▒▓███████▓▒░░▒▓████████▓▒░▒▓███████▓▒░  
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓███████▓▒░░▒▓███████▓▒░░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓███████▓▒░░▒▓██████▓▒░ ░▒▓███████▓▒░  
░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░      ░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░ 
░▒▓█▓▒░      ░▒▓█▓▒░░▒▓█▓▒░░▒▓██████▓▒░░▒▓███████▓▒░░▒▓█▓▒░      ░▒▓████████▓▒░▒▓█▓▒░░▒▓█▓▒░

press any key to start
"#;

pub fn context(app: &mut App) {
    app.add_systems(
        Update,
        (render, listen_input).run_if(in_state(Context::Initial)),
    );
}

fn render(mut term: ResMut<Terminal>, diagnostics: Res<DiagnosticsStore>) {
    term.draw(|frame: &mut Frame| {
        frame.render_widget(
            Text::raw(SPLASH).centered(),
            Layout::vertical([Constraint::Ratio(1, 3); 3]).split(frame.area())[1],
        );
        frame.render_widget(title_block(diagnostics), frame.area());
    })
    .unwrap();
}

fn listen_input(events: EventReader<Input>, mut state: ResMut<NextState<Context>>) {
    if !events.is_empty() {
        state.set(Context::Log)
    }
}
